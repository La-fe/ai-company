# CEO Plan RLHF — 规划质量进化循环

> 每一轮规划都是一次学习机会。通过结构化评估 → 反馈 → 进化，让每一轮的规划质量递增。

---

## 核心理念

规划不是一次性动作，而是持续进化的过程。RLHF 循环将每次规划的结果转化为可量化的信号，驱动规划规则和策略的迭代升级。

核心假设：
- 规划质量可以通过多维度评分客观衡量
- 用户反馈是最有价值的奖励信号
- 规则的有效性可以通过累积应用数据验证
- 低质量规则应该被自动弱化，高质量规则应该被自动强化

---

## 5 阶段循环

```
┌─────────────┐
│  Phase 1    │
│  Generate   │──→ CEO 按流程生成规划
└──────┬──────┘
       ▼
┌─────────────┐
│  Phase 2    │
│  Evaluate   │──→ 多维度评估打分
└──────┬──────┘
       ▼
┌─────────────┐
│  Phase 3    │
│  Feedback   │──→ ⏸️ 等待用户反馈
└──────┬──────┘
       ▼
┌─────────────┐
│  Phase 4    │
│  Update     │──→ 更新规则置信度
└──────┬──────┘
       ▼
┌─────────────┐
│  Phase 5    │
│  Consolidate│──→ 固化经验，淘汰弱规则
└──────┬──────┘
       │
       └──→ 回到 Phase 1（下一轮规划）
```

### Phase 1: Generate — 生成规划

CEO 按照标准流程生成规划产物。

**执行要求**：
- 按 PLAN / ROADMAP 模式标准流程生成 tasks.md / roadmap.md
- 记录生成过程中的关键决策点和所依赖的假设
- 标注哪些规则被应用了（用于后续追踪规则有效性）

**记录格式**：

```markdown
## 规划决策日志

### 应用的规则
- rule_id: planning-001 — "冷启动阶段 P0 不超过 3 个/维度"
- rule_id: planning-005 — "主要矛盾必须有数据支撑"

### 关键假设
1. 假设 A: [描述] — 验证方式: [如何验证]
2. 假设 B: [描述] — 验证方式: [如何验证]

### 决策取舍
- 选择了 X 而非 Y，因为 [原因]
```

### Phase 2: Evaluate — 多维度评估

对生成的规划进行结构化评估。

**执行流程**：
1. 读取评估维度定义: `plan-eval-dimensions.md`
2. 确定当前公司阶段，应用动态权重调整
3. 对规划逐维度打分（1-10 分）
4. 检查否决规则（Veto Rules）
5. 生成评估报告

**评估约束**：
- 打分必须给出具体理由，不允许笼统评价
- 每个维度至少列出 1 个扣分项或加分项
- 否决规则优先于总分判断

### Phase 3: Feedback — 人工反馈

**⏸️ WAIT — 必须暂停等待用户输入。**

**展示内容**：
1. 评估报告摘要（总分 + 各维度分数）
2. 关键风险点（评分最低的 2 个维度）
3. 改善建议（Top 3）

**收集内容**：
- 用户对每个维度评分的同意/调整
- 用户修改意见及原因（这是最重要的奖励信号）
- 用户对规划的整体判断: 通过 / 微调 / 重做

**反馈记录格式**：

```markdown
## 用户反馈

### 维度评分调整
| 维度 | AI 评分 | 用户评分 | 差异 | 用户说明 |
|------|--------|---------|------|---------|
| 主要矛盾准确性 | 7 | 8 | +1 | "这次抓得准，XXX 确实是核心问题" |
| 目标可达性 | 8 | 5 | -3 | "时间线太乐观了，XX 至少需要多 2 周" |

### 整体判断
- 决定: [通过 / 微调 / 重做]
- 理由: ...

### 关键修改意见
1. [具体修改内容及原因]
2. [具体修改内容及原因]
```

### Phase 4: Update — 规则更新

基于反馈信号更新规划规则的置信度。

**更新公式**：

```
Score = Σ(applied_count × feedback_signal) / total_applications
Confidence = 1 - 1/(applied_count + 1)
```

其中:
- `applied_count`: 该规则被应用的次数
- `feedback_signal`: +1（正面反馈）/ 0（中性）/ -1（负面反馈）
- `total_applications`: 所有规则的总应用次数

**突变策略**：

| 条件 | 动作 | 说明 |
|------|------|------|
| score > 0.7 | 强化规则 | 提升权重，标记为"已验证" |
| 0.3 < score < 0.7 | 保持观察 | 不调整，继续收集数据 |
| score < 0.3 | 弱化或废弃 | 降低权重，3 次连续低分则废弃 |
| confidence < 0.3 | 探索性调整 | 数据不足，保留但标记"待验证" |

**规则状态流转**：

```
candidate → active → verified → core_rule
                   ↘ deprecated → removed
```

### Phase 5: Consolidate — 固化经验

将本轮学习成果固化为持久化知识。

**固化规则**：
- 高分规则（score > 0.7 且 confidence > 0.7）→ 固化为 SOP 级别规则
- 低分规则（score < 0.3 且 confidence > 0.5）→ 标记为 deprecated，准备废弃
- 新发现的模式 → 生成新的 candidate 规则
- 反复出现的用户反馈主题 → 生成新的评估 checklist 条目

**输出产物**：
- 更新 `evolution-state.yaml`（如存在）
- 记录本轮进化日志
- 如有 SOP 级别规则变更，更新相关 reference 文件

**进化日志格式**：

```markdown
## 进化日志 — {date}

### 规则变更
| rule_id | 变更类型 | 变更前 | 变更后 | 原因 |
|---------|---------|--------|--------|------|
| planning-001 | score_update | 0.55 | 0.72 | 连续 3 次正面反馈 |
| planning-008 | deprecated | active | deprecated | 连续 3 次负面反馈 |
| planning-NEW-01 | created | — | candidate | 用户多次强调资源 buffer 重要性 |

### 累积统计
- 总规则数: X
- 活跃规则: X
- 已验证规则: X
- 废弃规则: X
- 本轮新增: X
- 本轮废弃: X
```

---

## 评估触发时机

| 时机 | 评估类型 | 说明 | 是否必须 |
|------|---------|------|---------|
| tasks.md 生成后 | 任务拆解质量评估 | 评估拆解的完备性、优先级、资源匹配 | PLAN 模式必须 |
| roadmap.md 生成后 | Roadmap 协调性评估 | 评估时间线、跨维度协调、里程碑合理性 | ROADMAP 模式必须 |
| 周期复盘时 | 回顾性评估 | 对比计划 vs 实际，评估规划准确度 | REVIEW 模式必须 |
| 用户主动触发 | 按需评估 | 用户对当前规划有疑虑时 | 任何时候 |

---

## 评估报告模板

```markdown
# 规划质量评估报告

**评估对象**: [tasks.md / roadmap.md / 综合评估]
**公司阶段**: [冷启动 / 增长期 / 成熟期]
**评估时间**: {date}

---

## 总分: X.X / 10.0

**决策层级**:
- >= 8.0: 可直接执行
- 7.0 - 7.9: 需微调后执行
- 6.0 - 6.9: 需重大修改
- < 6.0: 需重新规划

---

## 各维度评分

| # | 维度 | 权重 | 得分 | 加权分 | 简评 |
|---|------|------|------|--------|------|
| 1 | 主要矛盾准确性 | 20% | X | X.X | [一句话评价] |
| 2 | 目标可达性 | 15% | X | X.X | [一句话评价] |
| 3 | 任务完备性 | 15% | X | X.X | [一句话评价] |
| 4 | 优先级合理性 | 15% | X | X.X | [一句话评价] |
| 5 | 资源可行性 | 15% | X | X.X | [一句话评价] |
| 6 | 风险覆盖度 | 10% | X | X.X | [一句话评价] |
| 7 | 协调一致性 | 10% | X | X.X | [一句话评价] |

**加权总分**: X.X / 10.0

---

## 否决规则检查

- [ ] 主要矛盾得分 >= 4 — 方向正确
- [ ] 资源可行性得分 >= 3 — 非画饼
- [ ] P0 任务均有负责人 — 可执行
- [ ] P0 任务间无循环依赖 — 无死锁

**否决结果**: [通过 / 被否决 — 原因: ...]

---

## 关键风险点

1. **[最大风险维度]**: [具体描述]
2. **[次大风险维度]**: [具体描述]

---

## 改善建议 (Top 3)

1. **[建议标题]**: [具体可操作的改善动作]
2. **[建议标题]**: [具体可操作的改善动作]
3. **[建议标题]**: [具体可操作的改善动作]

---

## 应用的规则追踪

| rule_id | 规则内容 | 是否生效 | 备注 |
|---------|---------|---------|------|
| planning-XXX | ... | 是/否 | ... |
```

---

## 与其他系统的关系

| 系统 | 关系 | 数据流向 |
|------|------|---------|
| plan-eval-dimensions.md | 提供评估标准 | dimensions → Phase 2 |
| task-decomposition.md | 提供拆解方法论 | 方法论 → Phase 1 |
| review-framework.md | 复盘时触发回顾性评估 | 复盘数据 → Phase 2 |
| evolution-state.yaml | 存储规则进化状态 | Phase 5 → yaml → Phase 1 |
